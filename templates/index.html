<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicStream - 在线音乐平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/index.css">
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="top-nav">
        <div class="logo">
            <i class="fas fa-music"></i>
            MusicStream
        </div>

        <!-- 找到 search.html 中的搜索容器部分，修改 form 的 action 属性 -->
<div class="search-container">
    <!-- 关键修复：用 {% url 'search' page=1 %} 生成正确路由，确保提交到搜索视图的第1页 -->
    <form id="search-form" action="{% url 'search' page=1 %}" method="get">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" name="keyword"
               placeholder="搜索歌曲、艺术家或专辑..."
               value="{{ keyword|default:'' }}">  <!-- 保留关键词回显，提升体验 -->
    </form>
</div>

        <!-- 顶部导航 - 用户菜单单（替换原有代码） -->
<div class="user-menu">
    {% if request.user.is_authenticated %}
    <!-- 已登录：跳转用户中心（默认第1页） -->
    <a href="{% url 'home' page=1 %}" title="个人中心">
        <div class="user-avatar">
            {% if user_avatar %}
            <img src="{{ user_avatar }}" alt="用户头像" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
            {% else %}
            <i class="fas fa-user"></i>
            {% endif %}
        </div>
    </a>
    {% else %}
    <!-- 未登录：跳转登录页 -->
    <a href="{% url 'login' %}" class="login-link" title="登录">
        <div class="user-avatar">
            <i class="fas fa-user"></i>
        </div>
    </a>
    {% endif %}
</div>

    </nav>

    <div class="main-layout">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="nav-section">
                <div class="nav-title">发现</div>
                <a href="#" class="nav-item active">
                    <i class="fas fa-home"></i>
                    首页
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-compass"></i>
                    浏览
                </a>
                <a href="{% url 'ranking' %}" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    排行榜
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">我的音乐</div>
                <a href="collect.html" class="nav-item">
                    <i class="fas fa-heart"></i>
                    我喜欢的
                </a>
                <a href="recentPlay.html" class="nav-item">
                    <i class="fas fa-clock"></i>
                    最近播放
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-download"></i>
                    已下载
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">播放列表</div>
                <a href="#" class="nav-item">
                    <i class="fas fa-plus"></i>
                    创建播放列表
                </a>
            </div>
        </aside>

        <!-- 主内容 -->

<main class="main-content">
    <!-- 欢迎区域 -->
    <section class="welcome-section">
        <h1 class="welcome-title">发现好音乐</h1>
        <p class="welcome-subtitle">数百万首歌曲，个性化推荐，随时随地享受音乐</p>
        <button class="cta-button">开始探索</button>
    </section>

    <!-- 热搜歌曲 -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">热搜歌曲</h2>
            <a href="#" class="view-all">查看全部</a>
        </div>

        <div class="music-grid" style="grid-template-columns: repeat(3, 1fr);">
            {% for song_dynamic in searchs %}
            <div class="music-card"
                data-song-url="{{ song_dynamic.song.file.url }}"
                data-song-title="{{ song_dynamic.song.name }}"
                data-song-artist="{{ song_dynamic.song.singer }}"
                data-song-id="{{ song_dynamic.song.id }}">
                <div class="album-cover">
                    {% if song_dynamic.song.img %}
                    <img src="{{ song_dynamic.song.img.url }}" alt="{{ song_dynamic.song.name }}">
                    {% else %}
                    <i class="fas fa-compact-disc" style="font-size: 3rem;"></i>
                    {% endif %}
                    <div class="play-overlay">
                        <button class="play-button">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </div>
                <div class="song-title">{{ song_dynamic.song.name }}</div>
                <div class="artist-name">{{ song_dynamic.song.singer }}</div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- 推荐音乐 -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">为你推荐</h2>
            <a href="#" class="view-all">查看全部</a>
        </div>

        <div class="music-grid">
            {% for song in recommend %}
            <div class="music-card"
                data-song-url="{{ song.file.url }}"
                data-song-title="{{ song.name }}"
                data-song-artist="{{ song.singer }}"
                data-song-id="{{ song.id }}">
                <div class="album-cover">
                    {% if song.img %}
                    <img src="{{ song.img.url }}" alt="{{ song.name }}" style="width:100%; height:100%; object-fit:cover;">
                    {% else %}
                    <i class="fas fa-music"></i>
                    {% endif %}
                    <div class="play-overlay">
                        <button class="play-button">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </div>
                <div class="song-title">{{ song.name }}</div>
                <div class="artist-name">{{ song.singer }}</div>
            </div>
            {% endfor %}
        </div>
    </section>
</main>

    </div>

    <!-- 底部播放器 -->
    <div class="bottom-player">
        <!-- 底部播放器 - 当前歌曲区域（添加点击跳转逻辑） -->
        <div class="current-track" onclick="goToPlayPage()">
            <div class="track-cover">
                <i class="fas fa-music"></i>
            </div>
            <div class="track-info">
                <h4>选择一首歌曲</h4>
                <p>艺术家</p>
            </div>
        </div>

        <div class="player-controls">
            <button class="control-button" onclick="previousSong">
                <i class="fas fa-step-backward"></i>
            </button>
            <button class="control-button play-pause-btn" onclick="togglePlayPause()">
                <i class="fas fa-play"></i>
            </button>
            <button class="control-button">
                <i class="fas fa-step-forward"></i>
            </button>
        </div>
        <div class="progress-container">
            <span class="current-time">0:00</span>
            <div class="progress-slider" onclick="seekTo(event)">
                <div class="progress-fill"></div>
            </div>
            <span class="duration">0:00</span>
        </div>

        <div class="volume-control">
            <i class="fas fa-volume-up" onclick="toggleMute()"></i>
            <div class="volume-slider" onclick="setVolume(event)">
                <div class="volume-fill"></div>
            </div>
        </div>
        <audio id="audio-player" preload="metadata"></audio>
    </div>
    <script src="/static/js/index.js"></script>

</body>
</html>
<!-- 在 index.html 底部 </body> 前添加脚本 -->
<script src="/static/js/index.js"></script>
<script>
// 1. 记录当前选中的歌曲信息
let currentSong = null;

// 2. 为所有音乐卡片添加点击事件：记录当前歌曲
// 2. 为所有音乐卡片添加点击事件：记录当前歌曲 + 执行播放
document.querySelectorAll('.music-card').forEach(card => {
  card.addEventListener('click', function() {
    // 1. 获取卡片中的歌曲数据（原有逻辑保留）
    const songUrl = this.dataset.songUrl; // 关键：获取音频文件地址（之前遗漏使用）
    currentSong = {
      id: this.dataset.songId,
      title: this.dataset.songTitle,
      artist: this.dataset.songArtist,
      img: this.querySelector('.album-cover img')?.src || '',
      url: songUrl // 新增：记录音频地址
    };

    // 2. 视觉反馈（原有逻辑保留）
    document.querySelectorAll('.music-card').forEach(c => c.classList.remove('active'));
    this.classList.add('active');

    // 3. 同步更新底部播放器显示（原有逻辑保留）
    updateBottomPlayer(currentSong);

    // 4. 关键修复：设置音频地址并播放（新增逻辑）
    const audioPlayer = document.getElementById('audio-player'); // 获取底部音频元素
    if (audioPlayer && songUrl) {
      audioPlayer.src = songUrl; // 给音频元素设置当前歌曲的地址
      audioPlayer.play() // 执行播放
        .then(() => {
          console.log('开始播放:', currentSong.title);
          // 同步更新底部播放器的播放按钮图标（从 "播放" 变为 "暂停"）
          document.querySelector('.play-pause-btn i').className = 'fas fa-pause';
        })
        .catch(error => {
          console.error('播放失败:', error);
          alert('播放失败，请稍后重试');
        });
    }
  });
});

// 3. 更新底部播放器显示当前选中的歌曲
function updateBottomPlayer(song) {
  if (!song) return;
  const trackCover = document.querySelector('.bottom-player .track-cover');
  const trackTitle = document.querySelector('.bottom-player .track-info h4');
  const trackArtist = document.querySelector('.bottom-player .track-info p');

  // 更新封面（有图显示图，无图显示默认图标）
  if (song.img) {
    trackCover.innerHTML = `<img src="${song.img}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">`;
  } else {
    trackCover.innerHTML = '<i class="fas fa-music"></i>';
  }
  // 更新歌曲名和歌手
  trackTitle.textContent = song.title;
  trackArtist.textContent = song.artist;
}

// 4. 点击左下角播放器区域跳转至 play.html
function goToCurrentPlayPage() {
  if (!currentSong) {
    alert('请先选择一首歌曲播放');
    return;
  }
  // 用 URL 参数传递歌曲数据（歌词后续在play.html通过ID从后端获取）
  const queryParams = new URLSearchParams({
    id: currentSong.id,
    title: currentSong.title,
    artist: currentSong.artist,
    img: currentSong.img || ''
  });
  // 跳转到 play.html 并携带参数
  window.location.href = `/play/?${queryParams.toString()}`;
}
// 在 index.html 的脚本部分添加
function goToPlayPage() {
  if (!currentSong || !currentSong.id) {
    alert('请先选择一首歌曲播放');
    return;
  }
  // 使用 Django URL 模式跳转到播放页面
  window.location.href = `/play/${currentSong.id}.html`;
}
// 底部播放器：暂停/继续播放切换（新增函数）
function togglePlayPause() {
  const audioPlayer = document.getElementById('audio-player');
  const playIcon = document.querySelector('.play-pause-btn i');

  if (!audioPlayer.src) { // 若未选择歌曲，提示用户
    alert('请先选择一首歌曲');
    return;
  }

  if (audioPlayer.paused) { // 若当前暂停，则播放
    audioPlayer.play();
    playIcon.className = 'fas fa-pause';
  } else { // 若当前播放，则暂停
    audioPlayer.pause();
    playIcon.className = 'fas fa-play';
  }
}

// 修复 "上一曲" 按钮（避免控制台报错，可先留空实现）
function previousSong() {
  alert('上一曲功能待实现');
  // 后续可补充：获取歌曲列表，切换到上一首的逻辑
}
</script>